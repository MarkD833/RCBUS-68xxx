# 68302 Processor Board

![](../../images/MC68302_Front.JPG)

# Details
The processor board consists of a PGA packaged MC68302 processor, bits of glue logic and the processor clock source.

The processor board is designed to plug into an RCBus-80 backplane and expects to find the stack pointer and initial program counter addresses at location 0x000000 onwards. There is currently no fancy ROM & RAM switching hardware so ROM is always located at address 0x000000. However, as the 68302 is capable of swapping address ranges assigned the the chip selects, this feature will be implemented in software in the near future.

## Reset
The reset signal for the processor board must be supplied externally, entering the board via pin 20 of the RCBus connector. This should not be an issue if you are using one of Steve Cousins's backplanes.

## Processor Clock
The processor/system clock source is an oscillator in an 8-pin DIL/DIP can (X1 in the schematic). I used a turned pin socket to hold the oscillator as it made it easy to quickly swap in and out oscillators of different frequencies. Basic testing was done with a 7.3728MHz oscillator.

The 68302 doesn't have an E clock signal like the 68000 does so I chose to have the option to route the output of Timer #1 to the RCBus CLOCK2 pin (61) via a jumper.

Note that the CLOCK2 pin may also be used by the serial, parallel and multifunction boards (via jumpers on their boards) to share a clock source between them - usually to feed the baud rate generators and timers. If this feature is used, then the CLOCK2 jumper must not be fitted.

## Chip Selects
The 68302 processor has 4 user programmable chip select signals - /CS0, /CS1, /CS2 & /CS3.

/CS0 is automatically configured by the processor at reset for an 8K block of memory starting at address $000000. /CS0 would normally be used to select a non-volatile memory device that holds the boot code. My ROM/RAM board includes address decoding to select the pair of ROMs at address $000000 so /CS0 isn't needed. However there's a solder jumper that can be used to route it to RCBus pin 45 if required.

/CS1 is disabled by the processor at reset. I intended this chip select to select the volatile memory device on my ROM/RAM board, but as the board includes address decoding to select the pair of RAMs at address $100000, /CS1 isn't needed. However there's a solder jumper that can be used to route it to RCBus pin 46 if required.

/CS2 is disabled by the processor at reset. This chip select signal is used to enable access to the RCBus memory and i/o spaces. The /CS2 address decoding is configured for a 128K block of memory that is split into 2 64K blocks by half of a 74LS139. Accessing the lower 64K block generates an /MREQ on the RCBus and accessing the upper 64K block generates an /IORQ on the RCBus.

## DTACK & Bus Error
The user programmable chip select signals can also be configured to internally generate the DTACK signal so no external gates are required. My ROM/RAM board generates its own DTACK signal so DTACK is disabled for /CS0 & /CS1. /CS2 is configured to for 2 wait states.

The 68302 processor also includes an internal hardware watchdog that is enabled at reset and will generate a Bus Error if a DTACK isn't generated by the internal chip select logic or an external device.

## Serial Ports
Two of the 68302 serial ports - SCC1 & SCC2 - are fed to 6-pin connectors at the board edge. The layout of the 6 pins is compatible with an FTDI USB-TTL Serial interface board.

## SPI Port
The 68302 hardware SPI port (via SCC3 pins) is available on J6. Also on J6 is a chip select for the SPI device which is connected to port pin PB8 of the 68302.
 
## RCBus Signals
The RCBus specification (v1.0) doesn't specifically mention the 68000 in the backplane signal assignments table so there's a bit of wiggle room on the pins used.

I've stuck to the same signals for pins 1-40. The M1 signal isn't used and should have a 4K7 pullup resistor (manually added as I forgot it in my release 2.0 board!) and the USER1..USER4 which are used for the level 1, 3, 5 & 6 autovector interrupts.

Pins 41-80 carry D8..D15 as well as the higher address bits. Pins 41..44 have been used to carry some 68000 specific signals.

The current signal list is in the RCBus 68000 Pinout PDF file.

For the 68302 board, I have introduced 2 additional signals that can be routed onto the backplane to expose the /CS0 (pin 45) and /CS1 (pin 46) chip select signals. These are disconnected by default but can easily be connected by shorting solder jumpers JP1 (/CS0) and JP2 (/CS1) on the rear of the board.

The output of Timer #1 can be routed to the CLOCK2 pin to provide a clock source for other boards if required.

## RCBus memory space
The RCBus memory space is available via a 128K window in the 68302 address space. The hardware uses /CS2 to select this memory space with A16 determining either memory or I/O space as follows:
| Address Range | Signal |
| :---- | :---- |
| 0xFC0000..0xFCFFFF | /MREQ goes low |
| 0xFD0000..0xFDFFFF | /IORQ goes low |

This partial decoding results in the RCBus I/O memory space appearing multiple times within the 68000 address range. A DTACK signal is generated internally for any access to the RCBus whether there is a device present at that address or not.

For both I/O and memory spaces, consecutive memory locations are accessed on the ODD bytes such that I/O address 0x00 is accessed at address 0xFD0001, address 0x01 is accessed at address 0xFD0003 etc.

## Onboard LEDs
There are 4 LEDs on the board indicate accesses to the RCBus I/O and memory spaces as well as a HALT LED and a user LED (connected to port pin PB9).

## Power
The complete RCBus system can be powered from the 5V pin of one of the USB-TTL serial connectors by fitting a jumper in place on the appropriate pins of J3.

Note that there is a current limit of 500mA - imposed by the host system USB hardware - when the system is powered this way. It is relatively easy to exceed this limit once several boards are in use and I recommend that the system be powered from an external 5V supply connected to the RCBus backplane instead.

# Board Assembly
Assembly of the board should be fairly straightforward as there are no surface mount devices to deal with, but see the note below regarding the 68302 socket.

If you choose have a turned pin socket for the system clock, then an 8-pin DIL turned pin socket can be used. I flipped the socket over - pins pointing upwards - and easily pushed out pins 2,3,6 & 7.

When fitting the 80-pin right angle connector, initially only solder a couple of pins at opposite ends of the connector so that you can make any adjustments if the board is not vertical when fitted to the backplane.

# Note on the MC68302 socket
I could not get hold of the official PGA socket for the 68302 so I had to make my own from some SIL turned pin socket strips. From an earlier experiment I learnt that the plastic housing is slightly too wide so you can't simply butt together 13 SIL strips to make a socket. Instead I had to alternate between rows of pins in the plastic housing and rows of individual pins like this:

![](../images/MC68302_Pins_2.JPG)

This makes it a bit of a pain trying to get all the individual pins to play ball and line up with the PCB holes but it does work.

**Note:** Be careful with this method as I later discovered that the SIL turned pin sockets were not the low insertion force type. Once soldered into the board, the combined resistance of 132 turned pin sockets is such that the processor can't be removed without breaking it. The only way to get the processor out safely is by destroying the board with a handy rotary tool by cutting out the piece of board holding the processor and then carefully cutting off the pins very close to the board. The processor should then come away and the remains of the turned pin sockets can be easily removed individually. 

# Software
I've written a very simple monitor program for the 68302 board whick can be found in the ASM_CODE folder - called MON302. The monitor was initially developed using EASy68K.

## Interrupts
As the ROM is currently fixed at address 0x000000, the exception vector table addresses are also fixed. Exception vectors up to and including TRAP #15 each call their own handler stub within the monitor ROM. The remaining exception vectors are all directed to a single handler as they are not used within my design - i.e. vectored interrupts are not supported, only autovectored interrupts.

Each exception handler stub in the ROM (apart from bus error, address error and TRAP #15) looks up the start address of the actual exception handler code in a table of addresses held in RAM (which is initialised by the montor program). The table is located at the start of RAM occupying addresses 0x100000..0x1003FF and is laid out just like a normal exception vector table.

In order to use your own exception handler, you simply over write the RAM exception vector table entry with the address of your own handler.

# Jumpers
+ J1: Fit jumper to route Timer #1 output onto RCBus CLOCK2 but only if CLOCK2 is **not** being used to share a clock between the SIO, PIO and MFP boards.
+ J3: External 5V supply for the system
  + 1-2 : Power the system from the USB-TTL Serial board on Serial #1
  + 2-3 : Power the system from the USB-TTL Serial board on Serial #2
+ J4: Serial #1 port from SCC1
+ J5: Serial #2 port from SCC2
+ J6: SPI port

# Solder Jumpers
The 2 solder jumpers are located on the rear of the board and are used to route the 68302 /CS0 and /CS1 chip select signals onto the RCBus. With these jumpers soldered and a simple modification to the ROM/RAM board, the 68302 can boot from ROM at address $0000 and then swap the ROM and RAM so that RAM is located at address $0000.

+ JP1: solder this jumper to connect /CS0 to RCBus pin 45.
+ JP2: solder this jumper to connect /CS1 to RCBus pin 46.

# Errors
None so far.

# Thoughts / Enhancements
+ Should I have used SCC1 for the monitor port?
  + CTS1 is in input to SCC1 that can be used to tell SCC1 to stop transmitting.
  + RTS1 is an output from SCC1 and is asserted when SCC1 Tx buffer has data to send.
  + Don't appear to have software control over these pins to be able to tell the host PC to stop transmitting data to SCC1.
+ SCC2 provides software control of RTS2 (Port pin PA5) and CTS2 (Port pin PA4). Therefore can tell host PC to stop transmitting via software if our Rx buffers fill up.
+ SCC3 has no handshaking as the pins are used for the SPI interface.
+ For 115200 baud with RTS/CTS handshaking for quick xfer of srec files then it looks like SCC2 would be the better choice.

# To Do
+ Experiment to find the maximum width of board that JLCPCB will accept to keep the low price.
+ Modify the RCBus80 medium board footprint in Kicad so that pins 1,40,41 & 80 don't throw DRC warnings/errors.
